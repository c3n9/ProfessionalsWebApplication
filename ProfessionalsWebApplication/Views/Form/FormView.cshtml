@using ProfessionalsWebApplication.Models
@model FormModel

@{
	ViewData["Title"] = Model.Name;
}
<head>
	<link href="/styles/style.css" rel="stylesheet" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<form method="post" enctype="multipart/form-data" id="form" class="w">
	<h2>@Model.Name</h2>
	@foreach (var question in Model.Questions)
	{
		@if (question.Type == "Text")
		{
			<div class="input-container">
				<input type="text" class="form-control no-digits" name="@question.Text" id="question-@question.Id" @(question.IsRequired ? "required" : "") placeholder=" " pattern="^[^\d]*$" />
				<label for="question-@question.Id" class="floating-label">
					@question.Text.TrimEnd(':')
				</label>
				@* <p class="note">note</p> *@
			</div>
		}
		else if (question.Type == "Button" && question.Options != null && question.IsDropDown == false)
		{
			<div class="toggle-full">
				<label for="question-@question.Id">@question.Text</label>
				<div class="toggle-buttons">
					@foreach (var option in question.Options)
					{
						<input type="radio" name="@question.Text" value="@option" id="option-@question.Id-@option" @(question.IsRequired ? "required" : "") />
						<label class="toggle-button" for="option-@question.Id-@option">@option</label>
					}
				</div>
			</div>

		}
		else if (question.Type == "Button" && question.Options != null && question.IsDropDown == true)
		{
			<div class="custom-select-container">
				<select class="custom-select" name="@question.Text" id="question-@question.Id" @(question.IsRequired ? "required" : "")>
					<option value="" disabled selected hidden></option>
					@foreach (var option in question.Options)
					{
						<option value="@option">@option</option>
					}
				</select>
				<label class="select-placeholder">@question.Text.TrimEnd(':')</label>
				<div class="select-arrow">▼</div>
			</div>
		}
		else if (question.Type == "File")
		{
			<div class="file-upload">
				<label for="question-@question.Id">@question.Text</label>
				<label for="file-upload" class="upload-area">
					<div class="upload-icon">
						<svg width="50" height="50" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M25 31.125V4.58331M25 4.58331L31.125 11.7291M25 4.58331L18.875 11.7291" stroke="#1C5493" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
							<path d="M16.834 45.4167H33.1673C38.9411 45.4167 41.8301 45.4167 43.6227 43.6241C45.4173 41.8274 45.4173 38.9425 45.4173 33.1667V31.125C45.4173 25.3512 45.4173 22.4643 43.6227 20.6696C42.0547 19.1016 39.6496 18.9036 35.209 18.8791M14.7923 18.8791C10.3517 18.9036 7.94661 19.1016 6.37861 20.6696C4.58398 22.4643 4.58398 25.3512 4.58398 31.125V33.1667C4.58398 38.9425 4.58398 41.8295 6.37861 43.6241C6.99111 44.2366 7.73019 44.6388 8.66732 44.9042" stroke="#1C5493" stroke-width="3" stroke-linecap="round" />
						</svg>
					</div>
					<div class="upload-text">Перетащите файлы или нажмите для выбора</div>
					@* <div class="format-hint">Формат PDF</div> *@
					<input type="file" id="file-upload" class="file-input" accept=".pdf, .doc, .docx, image/*" @(question.IsRequired ? "required" : "")>
				</label>

				<div class="uploaded-files">
					<div class="uploaded-files-title">Загруженные файлы</div>
					<div id="file-list">
					</div>
				</div>
			</div>

		}
	}

	<button type="submit" class="btn btn-primary">Отправить</button>
</form>

<script>
	   document.getElementById('form').onsubmit = function(event) {
		event.preventDefault();

		let formData = new FormData(document.getElementById('form'));
		let data = {
			FormName: '@Model.Id',
			Answers: {},
		};

		let filePromises = [];

		formData.forEach((value, key) => {
			if (value instanceof File) {
				let reader = new FileReader();
				let filePromise = new Promise((resolve, reject) => {
					reader.onloadend = function() {
						data.Answers[key] = {
							FileName: value.name,
							FileSize: value.size,
							FileContent: reader.result.split(',')[1],
						};
						resolve();
					};
					reader.onerror = function() {
						reject('Ошибка при чтении файла');
					};
					reader.readAsDataURL(value);
				});

				filePromises.push(filePromise);
			} else {
				data.Answers[key] = value;
			}
		});

		Promise.all(filePromises)
			.then(() => {
				submitFormData(data);
			})
			.catch(error => {
				alert("Ошибка при обработке файлов: " + error);
			});
	};

	   function submitFormData(data) {
		fetch('/forms/submit', { // Убедись, что путь правильный
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		})
		.then(response => response.json())
		.then(result => {
			if (result.redirectUrl) {
				window.location.href = result.redirectUrl;
			}
		})
		.catch(error => {
			console.error('Произошла ошибка:', error);
		});
	}

		document.querySelectorAll('.select-container select').forEach(select => {
		// Обновление лейбла при изменении
		select.addEventListener('change', function() {
			this.setCustomValidity('');
			const label = this.nextElementSibling;
			if (this.value) {
				label.style.color = '#1C5493';
			} else {
				label.style.color = '#929292';
			}
		});

		// Инициализация при загрузке
		if (select.value) {
			select.nextElementSibling.style.color = '#1C5493';
		}
	});

	document.addEventListener('DOMContentLoaded', function() {
		const fileUpload = document.getElementById('file-upload');
		const fileList = document.getElementById('file-list');

		fileUpload.addEventListener('change', function(e) {
			// Очищаем список перед добавлением новых файлов (если не нужно сохранять предыдущие)
			// fileList.innerHTML = '';

			// Добавляем каждый выбранный файл в список
			for (let i = 0; i < this.files.length; i++) {
				addFileToList(this.files[i]);
			}
		});

		// Обработка перетаскивания файлов
		const uploadArea = document.querySelector('.upload-area');

		uploadArea.addEventListener('dragover', function(e) {
			e.preventDefault();
			this.classList.add('dragover');
		});

		uploadArea.addEventListener('dragleave', function(e) {
			e.preventDefault();
			this.classList.remove('dragover');
		});

		uploadArea.addEventListener('drop', function(e) {
			e.preventDefault();
			this.classList.remove('dragover');

			const files = e.dataTransfer.files;
			fileUpload.files = files; // Обновляем input files

			// Очищаем список перед добавлением новых файлов (если не нужно сохранять предыдущие)
			// fileList.innerHTML = '';

			// Добавляем каждый файл в список
			for (let i = 0; i < files.length; i++) {
				addFileToList(files[i]);
			}
		});

		function addFileToList(file) {
			const fileItem = document.createElement('div');
			fileItem.className = 'file-item';

			fileItem.innerHTML = `
			<div> <span class="file-icon">📄</span>
				<span class="file-name">${file.name}</span>
				</div>

				<button class="remove-file" title="Удалить">×</button>
			`;

			fileList.appendChild(fileItem);

			// Добавляем обработчик удаления файла
			const removeBtn = fileItem.querySelector('.remove-file');
			removeBtn.addEventListener('click', function() {
				fileItem.remove();
				// Здесь можно добавить логику для удаления файла из input.files
			});
		}
	});

</script>
